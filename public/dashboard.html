<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiasharaScore Dashboard</title>
    <link rel="shortcut icon" href="#">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; }
        
        /* SCORE CIRCLE */
        .score-circle { 
            width: 150px; height: 150px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 2.5rem; font-weight: bold; color: white; 
            margin: 0 auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        .bg-good { background-color: #28a745; }
        .bg-bad { background-color: #dc3545; }
        .bg-avg { background-color: #ffc107; color: black; }

        /* LOAN BOX ANIMATION */
        .loan-box { 
            border: 2px dashed #198754; 
            background: #f0fff4; 
            transition: transform 0.3s; 
        }
        .loan-box:hover { transform: scale(1.02); }

        /* PRINT STYLES (For the PDF Report) */
        @media print {
            body { background-color: white; }
            /* Hide Buttons and Navbars when printing */
            .navbar, .btn, #forecastBanner { display: none !important; } 
            .card { border: 1px solid #ddd !important; box-shadow: none !important; page-break-inside: avoid; }
            .container { max-width: 100%; margin: 0; padding: 0; }
            #scoreDisplay { color: black !important; border: 5px solid #333; }
            
            /* Professional Header for the PDF */
            body::before {
                content: "BiasharaScore AI - Official Credit Report";
                font-size: 24pt; font-weight: bold; display: block; 
                text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333;
            }
            /* Professional Footer */
            body::after {
                content: "Generated by BiasharaScore AI (Hackathon 2025). Valid for 30 days.";
                font-size: 10pt; color: #666; display: block; 
                text-align: center; margin-top: 50px;
            }
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark px-4">
        <a class="navbar-brand fw-bold" href="#">BiasharaScore AI</a>
        <a href="index.html" class="btn btn-outline-light btn-sm">New Upload</a>
    </nav>

    <div class="bg-primary text-white text-center py-2 small fw-bold" id="forecastBanner" style="display:none;">
        <i class="bi bi-graph-up-arrow"></i> <span id="forecastText">Processing trends...</span>
    </div>

    <div class="container mt-4 mb-5">
        <div class="row">
            
            <div class="col-md-4">
                
                <div class="card p-4 text-center shadow-sm">
                    <h5>Credit Trust Score</h5>
                    <div id="scoreDisplay" class="score-circle bg-secondary my-3">---</div>
                    <p id="riskText" class="fw-bold text-muted">Calculating...</p>
                    
                    <button onclick="window.print()" class="btn btn-outline-dark btn-sm w-100 mb-3">
                        <i class="bi bi-file-earmark-pdf"></i> Download Official Report
                    </button>

                    <hr>
                    <div class="text-start">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Total Income</small>
                            <span id="totalIncome" class="fw-bold text-success">KES 0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Total Expenses</small>
                            <span id="totalExpense" class="fw-bold text-danger">KES 0</span>
                        </div>
                    </div>
                </div>

                <div class="card p-4 shadow-sm mt-3 loan-box">
                    <h6 class="text-success fw-bold text-center"><i class="bi bi-bank"></i> Loan Qualification</h6>
                    <h3 class="text-center fw-bold mt-2" id="loanAmount">---</h3>
                    <p class="text-center small text-muted mb-2">Status: <span id="loanStatus" class="fw-bold">Checking...</span></p>
                    <button class="btn btn-success btn-sm w-100 shadow-sm">Apply Now</button>
                </div>

                <div class="card p-4 shadow-sm mt-3 border-0">
                    <h6 class="text-primary fw-bold"><i class="bi bi-lightbulb"></i> AI Explanation</h6>
                    <ul id="insightsList" class="list-group list-group-flush small mt-2">
                        <li class="list-group-item text-muted">Waiting for data...</li>
                    </ul>
                </div>
            </div>

            <div class="col-md-8">
                
                <div class="card p-4 mb-3 shadow-sm">
                    <h5 class="fw-bold">AI Expense Analysis</h5>
                    <p class="text-muted small">Spending breakdown by AI-detected category.</p>
                    <div style="height: 250px;"><canvas id="expenseChart"></canvas></div>
                </div>
                
                <div class="card p-4 shadow-sm">
                    <h5 class="fw-bold">Recent Transactions</h5>
                    <table class="table table-striped table-sm mt-2">
                        <thead><tr><th>Date</th><th>Description</th><th>Category (AI)</th><th>Amount</th></tr></thead>
                        <tbody id="txTableBody"><tr><td colspan="4">Loading...</td></tr></tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

    <script>
        async function loadDashboard() {
            try {
                // 1. Fetch Data
                const response = await fetch('http://localhost:3000/api/dashboard-data');
                
                if (!response.ok) {
                    throw new Error("Server communication failed.");
                }
                
                const data = await response.json();

                // 2. Update Score UI
                const scoreCircle = document.getElementById('scoreDisplay');
                scoreCircle.innerText = data.score;
                
                // Set Color based on Score
                scoreCircle.className = "score-circle my-3 " + (data.score >= 700 ? "bg-good" : data.score >= 500 ? "bg-avg" : "bg-bad");
                document.getElementById('riskText').innerText = data.score >= 700 ? "Risk: Low" : data.score >= 500 ? "Risk: Medium" : "Risk: High";

                // 3. Update Financials
                document.getElementById('totalIncome').innerText = `KES ${(data.summary.totalIncome||0).toLocaleString()}`;
                document.getElementById('totalExpense').innerText = `KES ${(data.summary.totalExpense||0).toLocaleString()}`;

                // 4. Update Prediction Banner
                if (data.prediction && data.prediction.forecastMsg) {
                    document.getElementById('forecastBanner').style.display = 'block';
                    document.getElementById('forecastText').innerText = "AI Forecast: " + data.prediction.forecastMsg;
                }

                // 5. Update Loan Offer
                document.getElementById('loanAmount').innerText = `KES ${(data.loanOffer.amount||0).toLocaleString()}`;
                document.getElementById('loanStatus').innerText = data.loanOffer.status;

                // 6. Update AI Insights List
                const list = document.getElementById('insightsList');
                list.innerHTML = '';
                (data.aiInsights || []).forEach(msg => {
                    let color = msg.includes("Positive") ? "text-success" : "text-danger";
                    let icon = msg.includes("Positive") ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill";
                    list.innerHTML += `<li class="list-group-item ${color} bg-transparent ps-0"><i class="bi ${icon}"></i> ${msg}</li>`;
                });

                // 7. Update Table
                const tbody = document.getElementById('txTableBody');
                tbody.innerHTML = '';
                data.transactions.slice(0, 5).forEach(tx => {
                    tbody.innerHTML += `<tr>
                        <td>${new Date(tx.transaction_date).toLocaleDateString()}</td>
                        <td>${tx.description}</td>
                        <td><span class="badge bg-info text-dark">${tx.category}</span></td>
                        <td class="${tx.type === 'CREDIT' ? 'text-success' : 'text-danger'} fw-bold">
                            ${tx.type === 'CREDIT' ? '+' : '-'} ${parseFloat(tx.amount).toLocaleString()}
                        </td>
                    </tr>`;
                });

                // 8. Update Chart
                const categories = {};
                data.transactions.forEach(tx => { 
                    if(tx.type==='DEBIT') { 
                        const cat = tx.category||'Other'; 
                        categories[cat] = (categories[cat]||0) + parseFloat(tx.amount); 
                    }
                });
                
                // Destroy old chart if exists (prevents glitching)
                const ctx = document.getElementById('expenseChart');
                if (window.myChart) window.myChart.destroy();

                window.myChart = new Chart(ctx, {
                    type: 'bar',
                    data: { 
                        labels: Object.keys(categories), 
                        datasets: [{ 
                            label: 'Expenses (KES)', 
                            data: Object.values(categories), 
                            backgroundColor: ['#3e95cd', '#8e5ea2', '#3cba9f', '#e8c3b9', '#c45850'] 
                        }] 
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

            } catch (error) { 
                console.error("Dashboard Error:", error); 
                alert("Failed to load data. Is the server running?");
            }
        }

        // Run on load
        loadDashboard();
    </script>
</body>
</html>